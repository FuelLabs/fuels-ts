import { readdirSync, mkdirSync, copyFileSync, renameSync, writeFileSync, rmSync } from 'fs';
import { join } from 'path';
import replace from 'replace';

type Link = {
  link: string;
  text: string;
  items: Link[];
  collapsed?: boolean;
};

/**
 * Post build script to trim off undesired leftovers from Typedoc, restructure directories and generate json for links.
 */
const docsDir = join(__dirname, '../src/');
const apiDocsDir = join(docsDir, '/api');
const classesDir = join(apiDocsDir, '/classes');
const modulesDir = join(apiDocsDir, '/modules');
const interfacesDir = join(apiDocsDir, '/interfaces_typedoc');

const filesToRemove = ['api/modules.md', 'api/classes', 'api/modules', 'api/interfaces_typedoc'];

const { log } = console;

/**
 * Removes unwanted files and dirs generated by typedoc.
 */
const removeUnwantedFiles = () =>
  filesToRemove.forEach((dirPath) => {
    const fullDirPath = join(docsDir, dirPath);
    rmSync(fullDirPath, { recursive: true, force: true });
  });

const renameInterfaces = async () => {
  await renameSync(join(apiDocsDir, 'interfaces'), join(apiDocsDir, 'interfaces_typedoc'));
};

/**
 * Generates a json file containing the links for the sidebar to be used by vitepress.
 */
const exportLinksJson = () => {
  const links: Link = { link: '/api/', text: 'API', items: [] };
  const directories = readdirSync(apiDocsDir);
  directories
    .filter((directory) => !directory.endsWith('.md'))
    .forEach((directory) => {
      links.items.push({ text: directory, link: `/api/${directory}/`, collapsed: true, items: [] });
      readdirSync(join(apiDocsDir, directory))
        .filter((file) => file !== 'index.md')
        .forEach((file) => {
          const index = links.items.findIndex((item) => item.text === directory);
          if (index !== -1) {
            const name = file.split('.')[0];
            links.items[index].items.push({
              text: name,
              link: `/api/${directory}/${name}`,
              items: [],
            });
          }
        });
    });

  writeFileSync('.typedoc/api-links.json', JSON.stringify(links));
};

/**
 * Alters the typedoc generated file structure to be more semantic.
 */
const alterFileStructure = async () => {
  const modulesFiles = readdirSync(modulesDir);
  const classesFiles = readdirSync(classesDir);
  const interfacesFiles = readdirSync(interfacesDir);
  const files = [
    ...classesFiles.map((c) => ({ name: c, path: classesDir })),
    ...interfacesFiles.map((i) => ({ name: i, path: interfacesDir })),
  ];

  await modulesFiles.forEach((modulesFile) => {
    // Create a new directory for each module
    const newDirName = modulesFile.split('.')[0];
    const newDirPath = join(apiDocsDir, newDirName);
    mkdirSync(newDirPath);

    files.forEach(({ name, path }) => {
      if (name.startsWith(newDirName)) {
        const newFilePath = join(newDirPath, name);
        copyFileSync(join(path, name), newFilePath);

        // Rename the file to remove module prefix
        renameSync(newFilePath, join(newDirPath, name.split('-')[1]));
      }
    });

    // Move module index file
    copyFileSync(join(modulesDir, modulesFile), join(newDirPath, 'index.md'));

    // Rename module directory to remove 'fuel_ts_' prefix
    const formattedDirName = newDirPath.split('fuel_ts_')[1];
    const capitalisedDirName = formattedDirName.charAt(0).toUpperCase() + formattedDirName.slice(1);
    renameSync(newDirPath, join(apiDocsDir, capitalisedDirName));
  });
};

/**
 * Recreates the generated typedoc links
 *
 * TODO: this should be done via the filesystem rather than hardcoded
 */
const recreateInternalLinks = () => {
  const regexReplaces = [
    // Module replacements
    { regex: 'fuel_ts_address.md', replacement: '/api/Address/index.md' },
    { regex: 'fuel_ts_interfaces.md', replacement: '/api/Interfaces/index.md' },
    { regex: 'fuel_ts_predicate.md', replacement: '/api/Predicate/index.md' },
    { regex: 'fuel_ts_wallet.md', replacement: '/api/Wallet/index.md' },
    { regex: 'fuel_ts_program.md', replacement: '/api/Program/index.md' },
    { regex: 'fuel_ts_contract.md', replacement: '/api/Contract/index.md' },
    { regex: 'fuel_ts_script.md', replacement: '/api/Script/index.md' },
    // Address replacements
    { regex: 'address-Address.md', replacement: '/api/Address/Address.md' },
    // Interfaces replacements
    { regex: 'interfaces-AbstractAccount.md', replacement: '/api/Interfaces/AbstractAccount.md' },
    { regex: 'interfaces-AbstractAddress.md', replacement: '/api/Interfaces/AbstractAddress.md' },
    { regex: 'interfaces-AbstractContract.md', replacement: '/api/Interfaces/AbstractContract.md' },
    // Predicate replacements
    { regex: 'predicate-Predicate', replacement: '/api/Predicate/Predicate' },
    // Wallet replacements
    { regex: 'wallet-Account.md', replacement: '/api/Wallet/Account.md' },
    { regex: 'wallet-BaseWalletUnlocked.md', replacement: '/api/Wallet/BaseWalletUnlocked.md' },
    { regex: 'wallet-WalletUnlocked.md', replacement: '/api/Wallet/WalletUnlocked.md' },
    { regex: 'wallet-WalletLocked.md', replacement: '/api/Wallet/WalletLocked.md' },
    { regex: 'wallet-Wallet.md', replacement: '/api/Wallet/Wallet.md' },
    // Program replacements
    { regex: 'program-Contract.md', replacement: '/api/Program/Contract.md' },
    { regex: 'program-ScriptRequest.md', replacement: '/api/Program/ScriptRequest.md' },
    {
      regex: 'program-FunctionInvocationResult',
      replacement: '/api/Program/FunctionInvocationResult',
    },
    {
      regex: 'program-FunctionInvocationScope',
      replacement: '/api/Program/FunctionInvocationScope',
    },
    { regex: 'program-InvocationResult', replacement: '/api/Program/InvocationResult' },
    { regex: 'program-InvokeFunctions', replacement: '/api/Program/InvokeFunctions' },
    {
      regex: 'program-MultiCallInvocationScope',
      replacement: '/api/Program/MultiCallInvocationScope',
    },
    // Contract replacements
    { regex: 'contract-ContractFactory.md', replacement: '/api/Contract/ContractFactory.md' },
    // Script replacements
    { regex: 'script-Script.md', replacement: '/api/Script/Script.md' },
    // Prefix cleanups
    { regex: '../modules/', replacement: '/api/' },
    { regex: '../classes/', replacement: '/api/' },
    { regex: '../interfaces/', replacement: '/api/' },
    { regex: 'fuel_ts_', replacement: '' },
    { regex: '/api//api/', replacement: '/api/' },
    // Resolves `[plugin:vite:vue] Element is missing end tag.` error
    { regex: '<', replacement: '&lt;' },
  ];

  const topLevelDirs = readdirSync(apiDocsDir);

  topLevelDirs
    .filter((directory) => !directory.endsWith('.md'))
    .forEach((dir) => {
      regexReplaces.forEach(({ regex, replacement }) => {
        replace({
          regex,
          replacement,
          paths: [join(apiDocsDir, dir)],
          recursive: true,
          silent: true,
        });
      });
    });
};

const main = async () => {
  log('Cleaning up docs.');
  await renameInterfaces();
  await alterFileStructure();
  removeUnwantedFiles();
  exportLinksJson();
  recreateInternalLinks();
};

main();
