name: Release to @rc-<name> tag on npm

on:
  pull_request:
    branches:
      - "master"

jobs:
  release-pr:
    if: false
    name: "Release breaking change PR to npm"
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: CI Setup
        uses: ./.github/actions/ci-setup

      - name: Ensure NPM access
        run: npm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build
        run: pnpm build

      - name: Add RC flag to PR name
        uses: frabert/replace-string-action@v2
        id: release_name
        with:
          string: ${{ github.head_ref }}
          pattern: "^(.*)$"
          replace-with: "rc-$1"

      - name: Release to @${{ steps.release_name.outputs.replaced }} tag on npm
        id: release
        run: |
          echo "${{ steps.release_name.outputs.replaced }}"
          echo "STEP 1"
          pnpm changeset:next
          echo "STEP 2"
          git add .changeset/fuel-labs-ci.md
          echo "STEP 3"
          pnpm changeset version --snapshot ${{ steps.release_name.outputs.replaced }}
          echo "STEP 4"
          changetsets=$(pnpm changeset publish --tag ${{ steps.release_name.outputs.replaced }})
          echo "STEP 5"
          published_version=$(echo "$changetsets" | grep -oP '@\K([0-9]+\.){2}[0-9]+-${{ steps.release_name.outputs.replaced }}-\d+' | head -1)
          echo "STEP 6"
          echo "published_version=$published_version" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add PR comment
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            Breaking change PR published under the `${{ steps.release_name.outputs.replaced }}` tag.
            Install it:
            ```bash
            pnpm add fuels@${{ steps.release_name.outputs.replaced }}
            pnpm add fuels@${{ steps.release.outputs.published_version }}
            ```
            Check it out:
            - https://www.npmjs.com/package/fuels/v/${{ steps.release_name.outputs.replaced }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
