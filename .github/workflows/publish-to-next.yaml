name: "Publish to next tag"

on:
  push:
    branches:
      - master

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  publish-to-next:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: CI Setup
        uses: ./.github/actions/ci-setup

      - name: Build
        run: pnpm build

      - name: Create .npmrc
        run: |
          cat << EOF > "$HOME/.npmrc"
            //npm.pkg.github.com/:_authToken=$GITHUB_TOKEN
            @FuelLabs:registry=https://npm.pkg.github.com
          EOF
        env:
          HOME: ${{ github.workspace }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release to @next tag on GitHub Packages
        run: |
          git checkout master

          CHANGESET_FILE=$(git diff-tree --no-commit-id --name-only HEAD -r ".changeset/*-*-*.md")
          if [ -z "$CHANGESET_FILE" ]; then
            echo "No changesets found, skipping release to @next tag"
            exit 0
          fi

          AFFECTED_PACKAGES=$(sed -n '/---/,/---/p' "$CHANGESET_FILE" | sed '/---/d')
          if [ -z "$AFFECTED_PACKAGES" ]; then
            echo "No packages affected by changesets, skipping release to @next tag"
            exit 0
          fi

          pnpm changeset:next
          pnpm changeset version --snapshot next
          pnpm changeset publish --tag next
        env:
          NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOME: ${{ github.workspace }}
          npm_config_registry: "https://npm.pkg.github.com"
